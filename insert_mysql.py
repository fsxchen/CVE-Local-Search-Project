#!/usr/bin/env python

import os
import sys
import re
import time
import MySQLdb
import string

def check_db():
    
    # check if there have the same name database
    
    print "db_check"
    conn = MySQLdb.connect(host='localhost',user='root',passwd='123456')
    curs = conn.cursor()
    curs.execute("show databases")
    
    for db in curs.fetchall():
          if db[0] == 'CVE_db':
              conn.close()
              return 1
          
    curs.execute("create database CVE_db")
    conn.close()
    return 0

def main():
    
    # main function
    
    now_time = time.localtime()
    syear_s = now_time.tm_year
    smon_s = now_time.tm_mon
    smday_s = now_time.tm_mday
    shour_s = now_time.tm_hour
    smin_s = now_time.tm_min
    ssec_s = now_time.tm_sec
    
    #print now_time.tm_year
    
    fp = open("allitems.txt", "r")
    
    re_check_db = check_db()
    conn = MySQLdb.connect(host = 'localhost', user = 'root', passwd = '123456', db = "CVE_db")
    curs = conn.cursor()
    
    CVE_db_name = "CVE_%d%d%d%d%d%d" % (syear_s, smon_s, smday_s, shour_s, smin_s, ssec_s)
    #CVE_db_name = "t"
    
    sql_1 = """create table %s
            (name char(20) not null,
            status char(20),
            url char(50),
            phase char(20),
            category char(20),
            reference char(100),
            current_votes char(100),
            voter_comments char(255),
            others char(255))""" % CVE_db_name
            
    curs.execute(sql_1)
    
    count_lines = 1
    flag = 0
    current_flag = 0
    voter_flag = 0
    
    for f in fp.readlines():
        #print flag
        point = re.match("========", f)
        if point != None:
            #print f
            if flag == 0:
                once_name = ""
                once_status = ""
                once_url = ""
                once_phase = ""
                once_category = ""
                once_reference = ""
                once_current_votes = ""
                once_voter_comments = ""
                once_others = ""
                flag = 1
            else:
                flag = 0
                
        if flag == 1:
            if current_flag == 1:
                if (f == "\n"):
                    current_flag = 0
                    print "i can work"
                    
                else:
                    once_current_votes = "%s%s\n" % (once_current_votes, f)
                
            elif voter_flag == 1:
                if (f == "\n"):
                    voter_flag == 0
                else:
                    once_voter_comments ="%s%s\n" % (once_voter_comments, f)
                    
            elif current_flag == 0 and voter_flag == 0:
                
                if len(f) != 0:
                    name_s = re.match("Name", f)
                    status_s = re.match("Status", f)
                    url_s = re.match("URL", f)
                    phase_s = re.match("Phase", f)
                    category_s = re.match("Category", f)
                    reference_s = re.match("Reference", f)
                    current_votes_s = re.match("Current", f)
                    voter_comments_s = re.match("Voter", f)
                    
                    if name_s != None:
                        print f
                        once_name_line_list = f.split(":")
                        once_name_line = once_name_line_list[1]
                        once_name = re.sub(" ", "", once_name_line)
                        
                    elif status_s != None:
                        print f
                        once_status_line_list = f.split(":")
                        once_status_line = once_status_line_list[1]
                        once_status = re.sub(" ", "", once_status_line)
                        
                    elif url_s != None:
                        print f 
                        once_url_line_list = f.split(":")
                        once_url_line = once_url_line_list[1]
                        once_url = re.sub(" ", "", once_url_line)
                        
                    elif phase_s != None:
                        print f
                        once_phase_line_list = f.split(":")
                        once_phase_line = once_phase_line_list[1]
                        once_phase = re.sub(" ", "", once_phase_line)
                        
                    elif category_s != None:
                        print f
                        once_category_line_list = f.split(":")
                        once_category_line = once_category_line_list[1]
                        once_category = re.sub(" ", "", once_category_line)
                        
                    elif reference_s != None:
                        print f
                        once_reference_line_list = f.split(":")
                        once_reference_line = once_reference_line_list[1]
                        once_reference_x = re.sub(" ", "", once_reference_line)
                        once_reference = "%s%s\n" % (once_reference, once_reference_x)
                        
                    elif current_votes_s != None:
                        current_flag = 1
                        
                    elif voter_comments_s != None:
                        voter_flag = 1
                        
                    else:
                        once_others = "%s%s\n" % (once_others, f)
                        
            elif flag == 0:
                
                sql_insert = """insert into %s
                            (name,
                            status,
                            url,
                            phase,
                            category,
                            reference,
                            current_votes,
                            voter_comments,
                            others)
                            
                            values 
                            
                            ('%s',
                            '%s',
                            '%s',
                            '%s',
                            '%s',
                            '%s',
                            '%s',
                            '%s')""" % (CVE_db_name, once_name, once_status, once_url, once_phase, once_category, once_reference, once_current_votes, once_voter_comments)
                            
                curs.execute(sql_insert)
                
    conn.commit()
    conn.close()
    fp.close()
    

if __name__ == "__main__":
    main()
