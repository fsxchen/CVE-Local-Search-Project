#!/usr/bin/env python

import os
import sys
import re
import time
import MySQLdb
import string

def check_db():
    
    # check if there have the same name database
    
    print "db_check"
    conn = MySQLdb.connect(host='localhost',user='root',passwd='123456')
    curs = conn.cursor()
    curs.execute("show databases")
    
    for db in curs.fetchall():
          if db[0] == 'CVE_db':
              conn.close()
              return 1
          
    curs.execute("create database CVE_db")
    conn.close()
    return 0

def main():
    
    # main function
    
    now_time = time.localtime()
    syear_s = now_time.tm_year
    smon_s = now_time.tm_mon
    smday_s = now_time.tm_mday
    shour_s = now_time.tm_hour
    smin_s = now_time.tm_min
    ssec_s = now_time.tm_sec
    
    #print now_time.tm_year
    
    fp = open("allitems.txt", "r")
    
    re_check_db = check_db()
    conn = MySQLdb.connect(host = 'localhost', user = 'root', passwd = '123456', db = "CVE_db")
    curs = conn.cursor()
    
    CVE_db_name = "CVE_%d%d%d%d%d%d" % (syear_s, smon_s, smday_s, shour_s, smin_s, ssec_s)
    #CVE_db_name = "t"
    
    sql_1 = """create table %s
            (name char(20) not null,
            status char(20),
            url char(50),
            phase char(20),
            category char(20),
            reference char(100),
            current_votes char(100),
            voter_comments char(255),
            others char(255))""" % CVE_db_name
            
    curs.execute(sql_1)
    
    count_lines = 1
    flag = 0
    two_object_flag = 0
    current_flag = 0
    voter_flag = 0
    
    for f in fp.readlines():
        #print flag
        point = re.match("========", f)
        if point != None:
            #print f
            if flag == 0:
                once_name = ""
                once_status = ""
                once_url = ""
                once_phase = ""
                once_category = ""
                once_reference = ""
                once_current_votes = ""
                once_voter_comments = ""
                once_others = ""
                flag = 1
                two_object_flag = 0
            else:
                flag = 0
                two_object_flag = 1
                
        if flag == 1:
            if current_flag == 1:
                if (f == "\n"):
                    current_flag = 0
                    #print "i can work"
                    
                else:
                    once_current_votes = "%s%s\n" % (once_current_votes, f)
                
            elif voter_flag == 1:
                if (f == "\n"):
                    voter_flag == 0
                else:
                    once_voter_comments ="%s%s\n" % (once_voter_comments, f)
                    
            elif current_flag == 0 and voter_flag == 0:
                
                if len(f) != 0:
                    name_s = None
                    status_s = None
                    status_s = None
                    url_s = None
                    phase_s = None
                    category_s = None
                    reference_s = None
                    current_votes_s = None
                    voter_comments_s = None
                    
                    name_s = re.match("Name", f)
                    status_s = re.match("Status", f)
                    url_s = re.match("URL", f)
                    phase_s = re.match("Phase", f)
                    category_s = re.match("Category", f)
                    reference_s = re.match("Reference", f)
                    current_votes_s = re.match("Current", f)
                    voter_comments_s = re.match("Voter", f)
                    
                    if name_s != None:
                        #print f
                        once_name_line_list = f.split(":")
                        #print once_name_line_list
                        once_name_line = once_name_line_list[1]
                        #print once_name_line
                        once_name = re.sub(" ", "", once_name_line)
                        print once_name
                        
                    elif status_s != None:
                        #int f
                        once_status_line_list = f.split(":")
                        once_status_line = once_status_line_list[1]
                        once_status = re.sub(" ", "", once_status_line)
                        
                    elif url_s != None:
                        #print f 
                        once_url_line_list = f.split(":")
                        once_url_line = once_url_line_list[1]
                        once_url = re.sub(" ", "", once_url_line)
                        
                    elif phase_s != None:
                        #print f
                        once_phase_line_list = f.split(":")
                        once_phase_line = once_phase_line_list[1]
                        once_phase = re.sub(" ", "", once_phase_line)
                        
                    elif category_s != None:
                        #print f
                        once_category_line_list = f.split(":")
                        once_category_line = once_category_line_list[1]
                        once_category = re.sub(" ", "", once_category_line)
                        
                    elif reference_s != None:
                        #print f
                        once_reference_line_list = f.split(":")
                        once_reference_line = once_reference_line_list[1]
                        once_reference_x = re.sub(" ", "", once_reference_line)
                        once_reference = "%s%s\n" % (once_reference, once_reference_x)
                        
                    elif current_votes_s != None:
                        current_flag = 1
                        
                    elif voter_comments_s != None:
                        voter_flag = 1
                        
                    else:
                        once_others = "%s%s\n" % (once_others, f)
                        
        elif flag == 0 and two_object_flag == 1:
            
            print 'execute the sql'
            #print once_name
            #print once_status
            #print once_url
            #print once_phase
            #print once_category
            #print once_reference
            #print once_current_votes
            #print once_voter_comments
            #print once_others
            
            
            if len(once_name) == 0:
                once_name = "No Value"
                
            if len(once_status) == 0:
                once_status = "No Value"
                
            if len(once_url) == 0:
                once_url = "No Value"
                
            if len(once_phase) == 0:
                once_phase = "No Value"
                
            if len(once_category) == 0:
                once_category = "No Value"
                
            if len(once_reference) == 0:
                once_reference = "No Value"
                
            if len(once_current_votes) == 0:
                once_current_votes = "No Value"
            if len(once_current_votes) > 254:
                once_current_votes = once_current_votes[0 : 250] + "..."
                
            if len(once_voter_comments) == 0:
                once_voter_comments = "No Value"
            if len(once_voter_comments) > 254:
                once_voter_comments = once_voter_comments[0 : 250] + "..."
                
            if len(once_others) == 0:
                once_others = "No Value"
            
            sql_insert = """insert into %s
                        (name,
                        status,
                        url,
                        phase,
                        category,
                        reference,
                        current_votes,
                        voter_comments)
                        
                        values 
                        
                        ('%s',
                        '%s',
                        '%s',
                        '%s',
                        '%s',
                        '%s',
                        '%s',
                        '%s')""" % (CVE_db_name, once_name, once_status, once_url, once_phase, once_category, once_reference, once_current_votes, once_voter_comments)
                        
            curs.execute(sql_insert)
                
    conn.commit()
    conn.close()
    fp.close()
    

if __name__ == "__main__":
    main()
